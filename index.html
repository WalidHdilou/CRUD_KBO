<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Recherche entreprise KBO</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      padding: 20px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
    }
    h1 {
      margin-top: 0;
    }
    .search-box {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    .search-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #2563eb;
      color: white;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .radio-group {
      display: flex;
      gap: 12px;
      font-size: 14px;
    }
    .message {
      margin-top: 8px;
      font-size: 14px;
    }
    .message.error {
      color: #b91c1c;
    }
    .message.info {
      color: #4b5563;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px 8px;
      text-align: left;
    }
    th {
      background: #f3f4f6;
    }
    .section-title {
      margin-top: 24px;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 15px;
    }
    .small {
      font-size: 12px;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Recherche d'entreprise KBO</h1>
    <p class="small">
      Recherche par <strong>numéro d'entreprise</strong> (ex : 0200.065.765) ou par <strong>nom</strong> (dénomination).
    </p>

    <div class="search-box">
      <div class="search-row">
        <input id="searchInput" type="text" placeholder="Numéro d'entreprise ou nom..." />
        <button id="searchBtn">Rechercher</button>
      </div>
      <div class="radio-group">
        <label>
          <input type="radio" name="searchType" value="number" checked />
          Par numéro
        </label>
        <label>
          <input type="radio" name="searchType" value="name" />
          Par nom
        </label>
      </div>
      <div id="message" class="message info"></div>
    </div>

    <div id="results" style="display:none;">
      <!-- ENTREPRISE -->
      <div class="section-title">Informations de l'entreprise</div>
      <table id="enterpriseTable">
        <tbody></tbody>
      </table>

      <!-- DENOMINATIONS -->
      <div class="section-title">Dénominations</div>
      <table id="denominationsTable">
        <thead>
          <tr>
            <th>Langue</th>
            <th>Type</th>
            <th>Nom / Dénomination</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- ETABLISSEMENTS -->
      <div class="section-title">Établissements</div>
      <table id="establishmentsTable">
        <thead>
          <tr>
            <th>Numéro d'établissement</th>
            <th>Date de début</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- ACTIVITÉS -->
      <div class="section-title">Activités (NACE)</div>
      <table id="activitiesTable">
        <thead>
          <tr>
            <th>Groupe</th>
            <th>Version</th>
            <th>Code NACE</th>
            <th>Classification</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- ADRESSES -->
      <div class="section-title">Adresses</div>
      <table id="addressesTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Rue (FR)</th>
            <th>Rue (NL)</th>
            <th>CP</th>
            <th>Commune (FR)</th>
            <th>Commune (NL)</th>
            <th>N°</th>
            <th>Boîte</th>
            <th>Info supp.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- CONTACTS -->
      <div class="section-title">Contacts</div>
      <table id="contactsTable">
        <thead>
          <tr>
            <th>Type</th>
            <th>Valeur</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- BRANCHES -->
      <div class="section-title">Branches</div>
      <table id="branchesTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Date de début</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8000/enterprises';

    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const messageEl = document.getElementById('message');
    const resultsEl = document.getElementById('results');

    const enterpriseTableBody = document.querySelector('#enterpriseTable tbody');
    const denominationsTableBody = document.querySelector('#denominationsTable tbody');
    const establishmentsTableBody = document.querySelector('#establishmentsTable tbody');
    const activitiesTableBody = document.querySelector('#activitiesTable tbody');
    const addressesTableBody = document.querySelector('#addressesTable tbody');
    const contactsTableBody = document.querySelector('#contactsTable tbody');
    const branchesTableBody = document.querySelector('#branchesTable tbody');

    function setMessage(text, type = 'info') {
      messageEl.textContent = text || '';
      messageEl.className = 'message ' + type;
    }

    function clearTables() {
      enterpriseTableBody.innerHTML = '';
      denominationsTableBody.innerHTML = '';
      establishmentsTableBody.innerHTML = '';
      activitiesTableBody.innerHTML = '';
      addressesTableBody.innerHTML = '';
      contactsTableBody.innerHTML = '';
      branchesTableBody.innerHTML = '';
    }

    async function doSearch() {
      const value = searchInput.value.trim();
      const searchType = document.querySelector('input[name="searchType"]:checked').value;

      if (!value) {
        setMessage("Merci de saisir un numéro d'entreprise ou un nom.", 'error');
        resultsEl.style.display = 'none';
        clearTables();
        return;
      }

      setMessage('Recherche en cours...', 'info');
      searchBtn.disabled = true;
      resultsEl.style.display = 'none';
      clearTables();

      try {
        const params = new URLSearchParams();
        if (searchType === 'number') {
          params.append('number', value);
        } else {
          params.append('name', value);
        }

        const response = await fetch(`${API_BASE_URL}/search?${params.toString()}`);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          const msg = errorData.message || `Erreur HTTP ${response.status}`;
          setMessage(msg, 'error');
          return;
        }

        const data = await response.json();

        // -------- ENTREPRISE --------
        const rows = [
          ['Numéro', data.enterprise_number],
          ['Status', data.status],
          ['Situation juridique', data.juridical_situation],
          ['Type', data.type_of_enterprise],
          ['Forme juridique', data.juridical_form],
          ['Forme CAC', data.juridical_form_cac],
          ['Date de début', data.start_date],
        ];

        rows.forEach(([label, value]) => {
          const tr = document.createElement('tr');
          const th = document.createElement('th');
          const td = document.createElement('td');
          th.textContent = label;
          td.textContent = value ?? '';
          tr.appendChild(th);
          tr.appendChild(td);
          enterpriseTableBody.appendChild(tr);
        });

        // -------- DENOMINATIONS --------
        if (Array.isArray(data.Denominations)) {
          data.Denominations.forEach(d => {
            const tr = document.createElement('tr');
            const tdLang = document.createElement('td');
            const tdType = document.createElement('td');
            const tdDenom = document.createElement('td');
            tdLang.textContent = d.language ?? '';
            tdType.textContent = d.type_of_denomination ?? '';
            tdDenom.textContent = d.denomination ?? '';
            tr.appendChild(tdLang);
            tr.appendChild(tdType);
            tr.appendChild(tdDenom);
            denominationsTableBody.appendChild(tr);
          });
        }

        // -------- ETABLISSEMENTS --------
        if (Array.isArray(data.Establishments)) {
          data.Establishments.forEach(e => {
            const tr = document.createElement('tr');
            const tdNum = document.createElement('td');
            const tdStart = document.createElement('td');
            tdNum.textContent = e.establishment_number ?? '';
            tdStart.textContent = e.start_date ?? '';
            tr.appendChild(tdNum);
            tr.appendChild(tdStart);
            establishmentsTableBody.appendChild(tr);
          });
        }

        // -------- ACTIVITÉS --------
        if (Array.isArray(data.Activities)) {
          data.Activities.forEach(a => {
            const tr = document.createElement('tr');
            const tdGroup = document.createElement('td');
            const tdVersion = document.createElement('td');
            const tdCode = document.createElement('td');
            const tdClass = document.createElement('td');
            tdGroup.textContent = a.activity_group ?? '';
            tdVersion.textContent = a.nace_version ?? '';
            tdCode.textContent = a.nace_code ?? '';
            tdClass.textContent = a.classification ?? '';
            tr.appendChild(tdGroup);
            tr.appendChild(tdVersion);
            tr.appendChild(tdCode);
            tr.appendChild(tdClass);
            activitiesTableBody.appendChild(tr);
          });
        }

        // -------- ADRESSES --------
        if (Array.isArray(data.Addresses)) {
          data.Addresses.forEach(ad => {
            const tr = document.createElement('tr');
            const tdType = document.createElement('td');
            const tdStreetFr = document.createElement('td');
            const tdStreetNl = document.createElement('td');
            const tdZip = document.createElement('td');
            const tdCityFr = document.createElement('td');
            const tdCityNl = document.createElement('td');
            const tdNum = document.createElement('td');
            const tdBox = document.createElement('td');
            const tdInfo = document.createElement('td');

            tdType.textContent = ad.type_of_address ?? '';
            tdStreetFr.textContent = ad.street_fr ?? '';
            tdStreetNl.textContent = ad.street_nl ?? '';
            tdZip.textContent = ad.zipcode ?? '';
            tdCityFr.textContent = ad.municipality_fr ?? '';
            tdCityNl.textContent = ad.municipality_nl ?? '';
            tdNum.textContent = ad.house_number ?? '';
            tdBox.textContent = ad.box ?? '';
            tdInfo.textContent = ad.extra_address_info ?? '';

            tr.appendChild(tdType);
            tr.appendChild(tdStreetFr);
            tr.appendChild(tdStreetNl);
            tr.appendChild(tdZip);
            tr.appendChild(tdCityFr);
            tr.appendChild(tdCityNl);
            tr.appendChild(tdNum);
            tr.appendChild(tdBox);
            tr.appendChild(tdInfo);

            addressesTableBody.appendChild(tr);
          });
        }

        // -------- CONTACTS --------
        if (Array.isArray(data.Contacts)) {
          data.Contacts.forEach(c => {
            const tr = document.createElement('tr');
            const tdType = document.createElement('td');
            const tdValue = document.createElement('td');
            tdType.textContent = c.contact_type ?? '';
            tdValue.textContent = c.value ?? '';
            tr.appendChild(tdType);
            tr.appendChild(tdValue);
            contactsTableBody.appendChild(tr);
          });
        }

        // -------- BRANCHES --------
        if (Array.isArray(data.Branches)) {
          data.Branches.forEach(b => {
            const tr = document.createElement('tr');
            const tdId = document.createElement('td');
            const tdStart = document.createElement('td');
            tdId.textContent = b.id ?? '';
            tdStart.textContent = b.start_date ?? '';
            tr.appendChild(tdId);
            tr.appendChild(tdStart);
            branchesTableBody.appendChild(tr);
          });
        }

        resultsEl.style.display = 'block';
        setMessage('Résultat trouvé.', 'info');
      } catch (err) {
        console.error(err);
        setMessage("Erreur lors de l'appel à l'API.", 'error');
      } finally {
        searchBtn.disabled = false;
      }
    }

    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        doSearch();
      }
    });
  </script>
</body>
</html>
